
# 🚀 Extreme-Novel-Reader: 极速索引小说阅读器

一款基于 Python + Tkinter 的多格式小说阅读器方案，支持 TXT、EPUB 等多种格式。从最初的 800 行代码全量加载架构，进化到了如今仅 300 行的"字节索引 + 延迟渲染"极致架构（TXT单文件版本）。项目采用模块化设计，支持扩展更多电子书格式。

## 🎯 核心功能

### 📁 文件处理
- **格式支持**：支持 TXT、EPUB、MOBI、AZW、AZW3 等多种电子书格式
- **EPUB格式**：支持 EPUB 文件的只读浏览，自动解析章节结构
- **MOBI格式**：支持 MOBI/AZW/AZW3 文件的只读浏览，自动提取文本内容
- **智能编码检测**：自动识别 UTF-8、GBK、GB2312 等常见编码
- **手动编码选择**：允许用户手动指定文件编码格式，并根据选择动态解码展示内容
- **大文件优化**：支持超大文本文件的快速加载和流畅阅读

### 📑 章节管理
- **智能章节识别**：通过正则表达式自动识别章节标题
- **动态目录生成**：根据章节标题自动生成可交互的侧边栏目录
- **章节跳转**：点击目录快速定位到指定章节
- **章节导航**：支持左右方向键在章节间切换（切换后目录会定位对应章节）
- **章节搜索**：在目录上方新增搜索框，支持模糊搜索实时过滤
- **快速定位**：支持通过编号直接定位（如输入#10跳转到第10个章节）

### 👁️ 阅读体验优化
- **调整字号**：可以动态调整字体大小，满足不同阅读需求
- **进度记忆**：存储阅读位置，保证同一路径的文件再次打开时恢复上次阅读位置
- **用时统计**：保存阅读用时（每本书和本次打开阅读器）
- **滚动同步**：实时显示阅读进度百分比（不遮挡阅读内容）
- **章内进度**：实时显示当前章节的阅读进度百分比
- **视觉舒适**：暖色调护眼配色方案，模拟纸质书阅读体验
- **键盘快捷键**：支持 PageUp/PageDown 翻页，E 键编辑章节
- **沉浸式排版**：自动清洗文本格式，实现完美对齐的Kindle式阅读体验
- **智能缩进**：阅读模式自动首行缩进，编辑模式取消缩进确保编辑精度

### ✏️ 文本编辑功能
- **TXT格式编辑**：支持TXT文件的实时编辑和保存，可修改原文件
- **EPUB/MOBI只读**：EPUB和MOBI格式支持只读浏览，暂不支持编辑
- **变更追踪**：对于TXT文件，明确提示用户有未保存的修改
- **实时保存**：支持TXT文件的实时保存，并在有未保存更改时提示用户

### 🎨 界面定制
- **主题切换**：暖色和绿色两种护眼模式
- **响应式布局**：支持字号和间距调整，保持合理的默认设置
- **侧边栏目录**：滑动式目录面板不影响阅读区域
- **进度指示**：底部进度条显示阅读完成度

## 使用说明

### 直接运行（已打包版本）

1. 解压下载的 `NovelReader-exe.*.zip` 压缩包
2. 运行 `NovelReader.exe` 即可

### 从源码运行

1. 确保已安装 Python 3.6+
2. 安装依赖：`pip install chardet` （可选，用于编码检测）
3. 运行：`python main.py`

### 基本操作

- `📁 打开文件` - 选择要阅读的小说文件
- 调整 `字号` 和 `行距` 以获得最佳阅读体验
- 选择不同的 `主题` 来改变界面外观
- 在 `章节列表` 中点击任意章节进行跳转
- 使用 `定位当前章节` 按钮快速回到当前位置
- 使用键盘 `←` 和 `→` 键快速切换章节

## 打包发布

### 自动打包并压缩

运行以下脚本之一：

- Windows 批处理脚本：`package_and_zip.bat` (仅模块化版本)
- Python 脚本（优先）：`python package_and_zip.py` (仅模块化版本)
- 通用打包脚本：`package_selector.bat` (支持选择打包模块化版本、单文件版本或两者)

### 手动打包

#### 打包模块化版本（支持扩展格式）

1. 确保已安装 `cx_Freeze`：`pip install cx_Freeze`
2. 运行打包命令：`python setup.py build`
3. 在 `build/极速小说阅读器` 目录中找到生成的可执行文件

#### 打包单文件版本（仅TXT支持）

对于只需要TXT格式支持的用户，可以打包单文件版本：

1. 确保已安装 `cx_Freeze`：`pip install cx_Freeze`
2. 运行打包命令：`python setup_single.py build`
3. 在 `build/极速小说阅读器-单文件版` 目录中找到生成的可执行文件

#### 使用通用打包脚本

运行 `package_selector.bat` 可以交互式选择要打包的版本：

1. 双击运行 `package_selector.bat`
2. 选择打包选项（模块化版本/单文件版本/两个版本都打包）
3. 脚本会自动完成打包和压缩

## 项目结构

### 模块化架构

为支持多格式阅读器，项目重构为模块化结构：

```
小说阅读器/
├── main.py                 # 主入口文件
├── setup.py                # 打包配置文件
├── build.bat              # 原始打包脚本
├── package_and_zip.bat    # 自动打包并压缩脚本（Windows）
├── package_and_zip.py     # 自动打包并压缩脚本（Python）
├── README.md              # 项目说明文档
├── core/                  # 核心解析器模块
│   ├── __init__.py
│   ├── base_parser.py     # 解析器基类
│   ├── txt_parser.py      # TXT格式解析器
│   └── ebook_parser.py    # 电子书格式解析器（预留接口）
├── ui/                    # 用户界面模块
│   ├── __init__.py
│   ├── app.py             # 主应用类
│   └── styles.py          # 样式配置
├── utils/                 # 工具函数模块
│   ├── __init__.py
│   ├── config.py          # 配置管理
│   ├── detector.py        # 编码检测
│   └── reader_settings.json  # 用户配置文件（运行后生成）
└── assets/                # 资源文件
    ├── novel_reader_MainPage.png
    └── HTML_NovelReader_Example.png
```

### 为纯TXT用户保留的单文件版本

对于只需要TXT格式支持的用户，项目仍然保留了原有的单文件版本，位于 `novel_reader.py`，具有相同的性能和功能：

- **高性能**：同样采用"字节索引 + 延迟渲染"架构
- **完整功能**：包含所有TXT阅读功能
- **独立部署**：单文件便于携带和分享
- **向后兼容**：与原有使用方式完全一致

## 扩展性说明

### 添加新格式支持

项目采用抽象基类设计，易于扩展新的电子书格式：

```python
from core.base_parser import BaseParser

class NewFormatParser(BaseParser):
    def scan(self, rule, callback, task_id):
        # 实现新格式的章节扫描逻辑
        pass

    def get_content(self, idx):
        # 实现新格式的内容提取逻辑
        pass

    def save_content(self, idx, content):
        # 实现新格式的内容保存逻辑（如果支持）
        pass
```

### 依赖安装

如需扩展EPUB等格式支持，需安装额外依赖：
```bash
pip install ebooklib beautifulsoup4 mobi

```

## 📸 界面预览

**主页面示例**

![主界面截图](assets/novel_reader_MainPage.png)
- **主题切换**：暖色和绿色两种护眼模式
- **响应式布局**：支持字号和间距调整，保持合理的默认设置
- **侧边栏目录**：滑动式目录面板不影响阅读区域
- **进度指示**：底部进度条显示阅读完成度

## 🔄 版本更新历史

### v4.2 "沉浸式 Kindle 模式" 更新

#### 核心特性
- **自动化清洗引擎**：在加载章节时自动剔除所有行首/行尾空格和Tab
- **标准化对齐**：配合Tag缩进技术，实现完美左侧垂直对齐效果
- **数据与表现分离**：保留原始编辑能力，确保保存时不丢失数据结构

#### 技术优化
- **全角空格支持**：优化正则匹配，支持Unicode全角空格（\u3000）识别
- **UTF-8 BOM处理**：正确处理字节序标记，避免匹配失败
- **索引器重构**：先解码为字符串再进行正则匹配，完美识别各种Unicode空格

### v4.1 "智能排版与搜索" 更新

#### 搜索功能
- **搜索栏**：在目录上方新增搜索框
- **模糊搜索**：输入关键字，目录实时过滤显示
- **编号定位**：支持通过数字直接定位（如输入#10跳转到第10个章节）
- **快捷清除**：搜索框为空时自动恢复全量显示

#### 排版优化
- **Tag机制**：创建"beauty_print"标签实现缩进，兼容所有Tkinter版本
- **整齐对齐**：设置spacing1、spacing2、spacing3实现段落间距和行距
- **智能缩进**：阅读模式自动首行缩进，编辑模式取消缩进确保编辑精度
- **章内进度**：实时显示当前章节阅读进度百分比



---

## 🏗 设计进化论：从"背诵全书"到"翻页阅读"

### 核心优化思路对比

| 维度 | GPT-5.3 Codex 设计 (v1.0) | Gemini 3.0 Flash 优化 (v3.5) | 稳定性改进 (v3.7) | 性能提升原理 |
|------|--------------------------|----------------------------|----------------------|-------------|
| **加载方式** | 全量加载，800行代码 | 字节索引+延迟渲染，300行代码 | 任务令牌+线程安全，350行代码 | 从O(n)到O(1) |
| **线程安全** | 单线程阻塞 | 多线程但存在竞态条件 | 工业级任务令牌机制 | 消除随机崩溃 |
| **文件切换** | 不支持 | 支持但会丢失进度 | 无缝切换，主动保存 | 完美状态保持 |
| **UI响应** | 卡顿明显 | 流畅但偶发崩溃 | 完全稳定，零崩溃 | 主线程隔离 |
| **目录刷新** | 全量刷新 | 增量刷新但闪烁 | 平滑增量刷新 | 无闪烁体验 |

### 🛡️ 稳定性改进 


**1. 任务令牌（Task Token）机制**
- **问题**：多文件切换时，旧索引线程仍在后台运行，导致UI控件访问冲突
- **解决方案**：每个扫描任务分配唯一ID，回调函数执行前验证任务有效性
- **效果**：彻底消除多线程UI崩溃，实现工业级稳定性

**2. 主动保存机制**
- **问题**：文件切换时旧文件进度丢失
- **解决方案**：在`open_file`起始阶段强制保存当前文件状态
- **效果**：实现无缝文件切换，完美保持阅读进度

**3. UI线程完全隔离**
- **改进**：所有UI操作通过`root.after(0, ...)`在主线程执行
- **效果**：确保Tkinter控件操作安全，消除随机崩溃隐患

**4. 性能微调优化**
- **字数统计**：两段式统计（快速估算+精确计算）
- **目录刷新**：增量式追加，消除闪烁现象
- **UI更新频率**：智能控制，避免过度刷新


---

## 🤖 模型设计差异：GPT vs Gemini

在开发过程中，我们观察到了两款模型在处理复杂需求时的显著差异：

*   **GPT-5.3 Codex (传统强者)：**
    *   **思维方式**：倾向于“完善性”。它会写出非常详尽的代码，考虑各种边界条件（如自动备份、复杂的异常捕获），代码风格偏向成熟的商业软件架构。
    *   **结果**：功能极多，但往往导致代码库变得庞大（Boilerplate 代码多），在处理极致性能问题时可能因为“想得太多”而忽略了最简单的物理路径。

*   **Gemini 3.0 Flash (架构极简主义)：**
    *   **思维方式**：倾向于“本质论”。它会试图找出问题的物理瓶颈（如字符串解码和 DOM 渲染的开销），并用最直接的底层原理（字节流操作）去重构。
    *   **结果**：代码极度精简，通过“物理索引”这一关键点，实现了跨量级的性能飞跃。它展示了如何用 1/3 的代码量完成更优的性能表现。

---

## 🌐 衍生项目：Qwen-based HTML Reader

仓库中还包含一个由 **Qwen 3.0 Coder** 编写的 Web 版阅读器：
*   **技术栈**：HTML5 / Vanilla JS / File API。
*   **设计思路**：利用浏览器 `FileReader` 的 `slice` 功能实现相同逻辑的“分块加载”。
*   **适用场景**：无需安装 Python 环境，直接在浏览器中秒开 GB 级文本。

主页面示例：
![主界面截图](assets/HTML_NovelReader_Example.png)

**核心功能**
- 支持 TXT 小说打开，智能识别并生成目录
- 提供暖色和护眼绿色两种背景主题
- 使用浏览器本地存储，支持定位上次阅读位置
   

> **注意**：此版本仅为实验性项目，暂无后续更新计划。只是 Qwen3.0 Coder 优先选择 HTML 实现 PC 端阅读器。


---

## 📜 结语

这个项目不仅是一个工具，更是 AI 协助人类进行**架构重构**的典型案例。从 GPT 的“大而全”到 Gemini 的“精而强”，我们见证了逻辑简化的力量。

---